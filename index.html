<!DOCTYPE html>
<head>
	<title>ARTS 445 #7: Interact</title>
	<style>
		body {
			font-size:180%;
			font-family:"Open Sans";
		}
		.text {
			position: fixed;
  			top: 50%;
  			left: 50%;
  			transform: translate(-50%, -50%);	
			text-align: center;
		}
		#oldest-text {
			color: black;
			font-family: "Helvetica";
			font-weight: bold;
		}
		#elapsed-text {
			color: black;
			font-family: "Helvetica";
			font-weight: bold;
		}
		#oldest-time {
			color: #8B0000;
			font-family: "Courier";
			font-weight: bold;
		}
		#elapsed-time {
			color: #8FBC8F;
			font-family: "Courier";
			font-weight: bold;
		}
	</style>
	<!-- load firebase and jquery code -->
	<script src="https://www.gstatic.com/firebasejs/4.12.0/firebase.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>

<body>
	<!-- firebase interaction code -->
	<script>
		
		var j = jQuery.noConflict();

		// firebase configuration
		var config = {
			apiKey: "AIzaSyApPrGgIGhmfVLYj1O0Hqa9x3HnTB_DIfw",
			authDomain: "arts445-project7.firebaseapp.com",
			databaseURL: "https://arts445-project7.firebaseio.com",
			projectId: "arts445-project7",
			storageBucket: "arts445-project7.appspot.com",
			messagingSenderId: "324623232843"
		};
	  
 		// set up database path references
		firebase.initializeApp(config);
		var db = firebase.database();
		var oldestTime = db.ref('oldestTime');
		var numUsers = db.ref('numUsers');
		var users = db.ref('users/');	
				
		// get start time of current user on page load
		var start_time = new Date(j.now());	// local version of startTime

		// push new data path to firebase
		var newUserRef = users.push({
			startedAt: start_time.getTime()
		});
		// Get the unique ID generated by push() by accessing its key
		var userKey = newUserRef.key;	
		
		var num_users;	// local version of numUsers
		// read num users data from database, save it locally
		numUsers.on('value', function(snapshot) { num_users = snapshot.val(); });
		var first = true; 	// boolean to set num_users += 1 in first window load
		
		var startTime = db.ref('users/' + userKey + '/startedAt');
		// read start time data from database, save it locally
		startTime.on('value', function(snapshot) { start_time = snapshot.val(); });
						
		// get start value of oldest user in database
		// users are sorted in ascending order by startedAt time so #1 is always oldest
		users.orderByChild('startedAt').limitToFirst(1).on('value', function(snapshot) {
			// extract oldest user key from snap.val() object 
			var items = [];
			snapshot.forEach((child) => {
    				items.push({
      					_key: child.key,
    				});
  			});
			
			var uKey = items[0]._key;
			var startVal = snapshot.child(uKey + '/startedAt').val();		// start time of oldest
			if (startVal == 0) startVal = start_time.getTime();		// first user on page
			
			oldestTime.set(startVal);	// update firebase with oldest value
		});
		
		var oldest_time;	// local version of oldestTime
		// read oldest time data from database, save it locally
		oldestTime.on('value', function(snapshot) { oldest_time = snapshot.val(); });
		
		// runs when page is fully loaded
		j(document).ready(function() {		
			
			// update program and webpage every second
			window.setInterval(function() {	
								
				if (first) {
					// add user to the database
					numUsers.set(num_users + 1);
					first = false;	// only add user once
				}
				
      				// get current time of machine
				var currTime = new Date(j.now());
				
				// calculate difference between oldest start and start of current page
				var difference = Math.abs(new Date(start_time) - new Date(oldest_time));
				var beforeSeconds = Math.floor(difference / 1000);
				var beforeMinutes = Math.floor(beforeSeconds / 60);
				beforeSeconds = beforeSeconds % 60;
				var beforeHours = Math.floor(beforeMinutes / 60);
				beforeMinutes = beforeMinutes % 60;
				
				// calculate duration of time on the current page
				var duration =  Math.abs(new Date(currTime) - new Date(start_time));
				var currSeconds = Math.floor(duration / 1000); 
				var currMinutes = Math.floor(currSeconds / 60); 
				currSeconds = currSeconds % 60;
				var currHours = Math.floor(currMinutes / 60);
				currMinutes = currMinutes % 60;
				
				// update html page to reflect elapsed time
				if (start_time == oldest_time) {
					j('#oldest-text').text("You are the oldest person on this page.");
				} else {
					j('#oldest-time').text(beforeHours + " hours, " + beforeMinutes + " minutes, and " + beforeSeconds + " seconds");
				}
				j('#elapsed-time').text(currHours + " hours, " + currMinutes + " minutes, and " + currSeconds + " seconds");
			
			}, 1000); // update page every second
		});

		// handle window close/refresh event
		j(window).on("beforeunload", function() {		 
			// delete current user from Firebase
			db.ref('users/' + userKey).remove();
			// If last user is deleted, reset oldestTime to 0
			numUsers.set(num_users - 1);
			if (num_users == 0) oldestTime.set(0);
		});

	</script>
	
	<div class="text">
		<p id="oldest-text">The oldest person on this page has been here<br><span class="time" id="oldest-time">... loading ...</span><br>longer than you.</p>
		<p id="elapsed-text">You've been on this page for<br><span class="time" id="elapsed-time">... loading ...</span>.</p>
	</div>
	
</body>
</html>
