<!DOCTYPE html>
<head>
	<title>ARTS 445 #7: Interact</title>
	<style>
		body {
			font-size:25px;
			font-family:"Helvetica";
			color: black;
			font-family: "Helvetica";
			font-weight: bold;
		}
		.text {
			position: fixed;
			width: 70%;
  		top: 50%;
  		left: 50%;
  		transform: translate(-50%, -50%);	
			text-align: center;
		}
		#oldest-text {
		}
		#elapsed-text {
		}
		#oldest-time {
			color: #8B0000;
		}
		#elapsed-time {
			color: #8FBC8F;
		}
	</style>
	<!-- load firebase and jquery code -->
	<script src="https://www.gstatic.com/firebasejs/4.12.0/firebase.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>

<body>
	<!-- firebase interaction code -->
	<script>
		
		// TODO: numUsers decreases but users don't delete
		// TODO: user can exist but not be active (laptop close, etc)
		// TODO: don't let numUsers go under 0
		
		var j = jQuery.noConflict();

		// firebase configuration
		var config = {
			apiKey: "AIzaSyApPrGgIGhmfVLYj1O0Hqa9x3HnTB_DIfw",
			authDomain: "arts445-project7.firebaseapp.com",
			databaseURL: "https://arts445-project7.firebaseio.com",
			projectId: "arts445-project7",
			storageBucket: "arts445-project7.appspot.com",
			messagingSenderId: "324623232843"
		};
	  
 		// set up database path references
		firebase.initializeApp(config);
		var db = firebase.database();
		var oldestTime = db.ref('oldestTime');
		var numUsers = db.ref('numUsers');
		var users = db.ref('users/');	
				
		// get start time of current user on page load
		var start_time = new Date(j.now());	// local version of startTime

		// push new data path to firebase
		var newUserRef = users.push({
			startedAt: start_time.getTime()
		});
		// Get the unique ID generated by push() by accessing its key
		var userKey = newUserRef.key;	
		
		var num_users;	// local version of numUsers
		// read num users data from database, save it locally
		numUsers.on('value', function(snapshot) { num_users = snapshot.val(); });
		var first = true; 	// boolean to set num_users += 1 in first window load
		
		var startTime = db.ref('users/' + userKey + '/startedAt');
		// read start time data from database, save it locally
		startTime.on('value', function(snapshot) { start_time = snapshot.val(); });
						
		// get start value of oldest user in database
		// users are sorted in ascending order by startedAt time so #1 is always oldest
		users.orderByChild('startedAt').limitToFirst(1).on('value', function(snapshot) {
			// extract oldest user key from snap.val() object 
			var items = [];
			snapshot.forEach((child) => {
    		items.push({
      		_key: child.key,
    		});
  		});
			
			var uKey = items[0]._key;
			var startVal = snapshot.child(uKey + '/startedAt').val();		// start time of oldest
			if (startVal == 0) startVal = start_time.getTime();		// first user on page
			
			oldestTime.set(startVal);	// update firebase with oldest value
		});
		
		var oldest_time;	// local version of oldestTime
		// read oldest time data from database, save it locally
		oldestTime.on('value', function(snapshot) { oldest_time = snapshot.val(); });
		
		var pageActive = true;		// determines if a user ever leaves the page
		var alreadyDeleted = false; 	// determines if program has already processed delete user
		// runs when page is fully loaded
		j(document).ready(function() {		
			
			// update program and webpage every second
			window.setInterval(function() {	
								
				if (first) {
					// add user to the database
					numUsers.set(num_users + 1);
					first = false;	// only add user once
					pageActive = true;
					alreadyDeleted = false;
				}
				
				// only update if the user hasn't left the page
				if (pageActive) {		
					// get current time of machine
					var currTime = new Date(j.now());

					// calculate difference between oldest start and start of current page
					var difference = Math.abs(new Date(start_time) - new Date(oldest_time));
					var beforeSeconds = Math.floor(difference / 1000);
					var beforeMinutes = Math.floor(beforeSeconds / 60);
					beforeSeconds = beforeSeconds % 60;
					var beforeHours = Math.floor(beforeMinutes / 60);
					beforeMinutes = beforeMinutes % 60;

					// calculate duration of time on the current page
					var duration =  Math.abs(new Date(currTime) - new Date(start_time));
					var currSeconds = Math.floor(duration / 1000); 
					var currMinutes = Math.floor(currSeconds / 60); 
					currSeconds = currSeconds % 60;
					var currHours = Math.floor(currMinutes / 60);
					currMinutes = currMinutes % 60;

					// display "1 hour/minute/second" instead of "1 hours/minutes/seconds"
					var oldHourText, currHourText;
					oldHourText = currHourText = " hours";
					if (beforeHours == 1) oldHourText = " hour";
					if (currHours == 1) currHourText = " hour";
					var oldMinuteText, currMinuteText;
					oldMinuteText = currMinuteText = " minutes";
					if (beforeMinutes == 1) oldMinuteText = " minute";
					if (currMinutes == 1) currMinuteText = " minute";
					var oldSecondText, currSecondText;
					oldSecondText = currSecondText = " seconds";
					if (beforeSeconds == 1) oldSecondText = " second";
					if (currSeconds == 1) currSecondText = " second";

					// update html page to reflect elapsed time
					if (start_time == oldest_time) {
						// current user has stayed on this page the longest
						j('#oldest-text').html("You've stayed longer than anyone else on this page.");
					} else {
						if (beforeHours == 0) {
							if (beforeMinutes == 0 ) {
								// don't display 0h 0m, only display seconds since first person arrived
								j('#oldest-time').text(beforeSeconds + " " + oldSecondText);
							} else {
								// dont diplay 0h, only display minutes and seconds since first person arrived
								j('#oldest-time').text(beforeMinutes + oldMinuteText + " and "+ beforeSeconds + oldSecondText);
							}
						} else {
							// display all hours minutes seconds since first person arrived
							j('#oldest-time').text(beforeHours + oldHourText + ", " + beforeMinutes + oldMinuteText + ", and " + beforeSeconds + oldSecondText);
						}
					}
					// display all hours minutes seconds that current user has been on the page
					j('#elapsed-time').text(currHours + currHourText + ", " + currMinutes + currMinuteText + ", and " + currSeconds + currSecondText);
				}
			}, 1000); // update page every second
		});

		// handle window close/refresh event
		j(window).on("beforeunload", function() {		
			// if delete hasn't already been done by visibility change
			if (!alreadyDeleted) {
				// delete current user from Firebase
				db.ref('users/' + userKey).remove();
				// If last user is deleted, reset oldestTime to 0
				numUsers.set(num_users - 1);
				if (num_users <= 0) {
					oldestTime.set(0);
					numUsers.set(0);
				}
				// don't let the same user be deleted multiple times
				alreadyDeleted = true;
			}
		});
		
		// user has navigated away from the page/tab
		/*j(window).on("visibilitychange", function() {
			// UI informs inactive user when they navigate back to the page
			j('.text').html("<p>You have left the page and are now inactive.</p><p>Please refresh the page.</p>");
			pageActive = false;		// stop any more UI updates or calculations
			
			// if delete hasn't already been done by page close
			if (!alreadyDeleted) {
				// delete current user from Firebase
				db.ref('users/' + userKey).remove();
				// If last user is deleted, reset oldestTime to 0
				numUsers.set(num_users - 1);
				if (num_users <= 0) {
					oldestTime.set(0);
					numUsers.set(0);
				}
				// don't let the same user be deleted multiple times
				alreadyDeleted = true;
			}
		});*/

	</script>
	
	<div class="text">
		<p id="oldest-text">The leading person to stay on this page arrived<br><span class="time" id="oldest-time">... loading ...</span>  before you.</p>
		<p id="elapsed-text"><br/>You've been on this page for<br><span class="time" id="elapsed-time">... loading ...</span>.</p>
	</div>
	
</body>
</html>